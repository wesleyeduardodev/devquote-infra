apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # ConfiguraÃ§Ã£o do serviÃ§o de email
  service.email.gmail: |
    username: $email-username
    password: $email-password
    host: smtp.gmail.com
    port: 587
    from: DevQuote Argo CD <noreply@devquote.com.br>

  # Template de email para sync failure
  template.app-sync-failed: |
    email:
      subject: "[DevQuote] âŒ Argo CD Sync FALHOU - {{.app.metadata.name}}"
    message: |
      âš ï¸ FALHA NO SYNC DO ARGO CD

      ğŸ“¦ AplicaÃ§Ã£o: {{.app.metadata.name}}
      ğŸ”´ Status: {{.app.status.sync.status}}
      ğŸ• Data/Hora: {{.time}}

      ğŸ’¬ Mensagem de Erro:
      {{range .app.status.conditions}}
      - {{.type}}: {{.message}}
      {{end}}

      ğŸ”§ AÃ§Ã£o NecessÃ¡ria:
      1. Acessar Argo CD: https://devquote.com.br/argocd
      2. Verificar logs da aplicaÃ§Ã£o
      3. Verificar manifestos no repositÃ³rio Git

      ğŸ”— Link direto: https://devquote.com.br/argocd/applications/{{.app.metadata.name}}

      ---
      DevQuote - Sistema de GestÃ£o de Projetos

  # Template de email para degraded status
  template.app-degraded: |
    email:
      subject: "[DevQuote] âš ï¸ AplicaÃ§Ã£o DEGRADADA - {{.app.metadata.name}}"
    message: |
      âš ï¸ APLICAÃ‡ÃƒO EM ESTADO DEGRADADO

      ğŸ“¦ AplicaÃ§Ã£o: {{.app.metadata.name}}
      ğŸŸ¡ Status de SaÃºde: {{.app.status.health.status}}
      ğŸ• Data/Hora: {{.time}}

      ğŸ’¬ Mensagem:
      {{.app.status.health.message}}

      ğŸ”§ AÃ§Ã£o NecessÃ¡ria:
      1. Verificar logs dos pods
      2. Verificar recursos (CPU/Memory)
      3. Verificar conectividade

      ğŸ”— Link direto: https://devquote.com.br/argocd/applications/{{.app.metadata.name}}

      ---
      DevQuote - Sistema de GestÃ£o de Projetos

  # Template de email para out of sync
  template.app-out-of-sync: |
    email:
      subject: "[DevQuote] ğŸ”„ AplicaÃ§Ã£o fora de sincronia - {{.app.metadata.name}}"
    message: |
      ğŸ”„ APLICAÃ‡ÃƒO FORA DE SINCRONIA

      ğŸ“¦ AplicaÃ§Ã£o: {{.app.metadata.name}}
      ğŸ”µ Status: {{.app.status.sync.status}}
      ğŸ• Data/Hora: {{.time}}

      ğŸ’¬ Recursos nÃ£o sincronizados:
      {{range .app.status.sync.revision}}
      - RevisÃ£o Git: {{.}}
      {{end}}

      â„¹ï¸ O Argo CD irÃ¡ sincronizar automaticamente em breve (selfHeal: true).

      ğŸ”— Link direto: https://devquote.com.br/argocd/applications/{{.app.metadata.name}}

      ---
      DevQuote - Sistema de GestÃ£o de Projetos

  # Triggers: quando enviar notificaÃ§Ãµes
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  trigger.on-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-degraded]

  trigger.on-out-of-sync: |
    - when: app.status.sync.status == 'OutOfSync'
      send: [app-out-of-sync]

  # Subscriptions globais (todas as apps)
  subscriptions: |
    - recipients:
      - wesleyeduardo.dev@gmail.com
      triggers:
      - on-sync-failed
      - on-degraded
