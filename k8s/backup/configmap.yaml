apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-backup-script
  namespace: devquote
data:
  backup.sh: |
    #!/bin/bash
    set -e

    # FunÃ§Ã£o para enviar email de erro
    send_error_email() {
      ERROR_MESSAGE="$1"

      python3 <<EOF
import smtplib
import os
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime

try:
    # ConfiguraÃ§Ãµes SMTP
    smtp_server = os.environ.get('MAIL_HOST', 'smtp.gmail.com')
    smtp_port = int(os.environ.get('MAIL_PORT', '587'))
    smtp_user = os.environ.get('MAIL_USERNAME', '')
    smtp_pass = os.environ.get('MAIL_PASSWORD', '')
    from_email = "DevQuote Backup <noreply@devquote.com.br>"
    to_email = "wesleyeduardo.dev@gmail.com"

    # Criar mensagem
    msg = MIMEMultipart()
    msg['From'] = from_email
    msg['To'] = to_email
    msg['Subject'] = "[DevQuote] âŒ FALHA NO BACKUP PostgreSQL"

    body = f"""âš ï¸ FALHA NO BACKUP DO BANCO DE DADOS

ðŸ• Data/Hora: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC
ðŸ“¦ Componente: PostgreSQL Backup CronJob
ðŸ”´ Status: ERRO

ðŸ’¬ Mensagem de Erro:
{'''$ERROR_MESSAGE'''}

ðŸ”§ AÃ§Ã£o NecessÃ¡ria:
1. Verificar logs: kubectl logs -n devquote -l app=postgres-backup
2. Verificar credenciais AWS S3
3. Verificar conectividade com PostgreSQL

ðŸ”— Dashboard: https://devquote.com.br/argocd

---
DevQuote - Sistema de GestÃ£o de Projetos"""

    msg.attach(MIMEText(body, 'plain'))

    # Enviar email
    server = smtplib.SMTP(smtp_server, smtp_port)
    server.starttls()
    server.login(smtp_user, smtp_pass)
    text = msg.as_string()
    server.sendmail(from_email, to_email, text)
    server.quit()

    print("âœ“ Email de erro enviado com sucesso")
except Exception as e:
    print(f"âœ— Erro ao enviar email: {e}")
EOF
    }

    # Trap para capturar erros e enviar email
    trap 'send_error_email "Erro na linha $LINENO: $BASH_COMMAND"' ERR

    echo "=========================================="
    echo "DevQuote - PostgreSQL Backup to S3"
    echo "Started at: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "=========================================="

    # VariÃ¡veis
    BACKUP_DIR="/tmp/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="devquote_backup_${TIMESTAMP}.sql.gz"
    S3_BUCKET="${AWS_S3_BUCKET_NAME}"
    S3_PATH="s3://${S3_BUCKET}/backups/postgresql/${BACKUP_FILE}"
    RETENTION_DAYS=7

    # Criar diretÃ³rio temporÃ¡rio
    mkdir -p ${BACKUP_DIR}
    cd ${BACKUP_DIR}

    echo "â†’ Creating PostgreSQL dump..."
    PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
      -h postgres-service \
      -p 5432 \
      -U "${POSTGRES_USER}" \
      -d "${POSTGRES_DB}" \
      --no-owner \
      --no-acl \
      | gzip > "${BACKUP_FILE}"

    BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    echo "âœ“ Backup created: ${BACKUP_FILE} (${BACKUP_SIZE})"

    # Configurar AWS CLI
    echo "â†’ Configuring AWS CLI..."
    export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
    export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
    export AWS_DEFAULT_REGION="${AWS_S3_REGION}"

    # Upload para S3
    echo "â†’ Uploading to S3: ${S3_PATH}"
    aws s3 cp "${BACKUP_FILE}" "${S3_PATH}" --storage-class STANDARD_IA

    if [ $? -eq 0 ]; then
      echo "âœ“ Backup uploaded successfully to S3"
    else
      echo "âœ— ERROR: Failed to upload backup to S3"
      exit 1
    fi

    # Limpar backups antigos no S3 (mantÃ©m Ãºltimos 7 dias)
    echo "â†’ Cleaning old backups (keeping last ${RETENTION_DAYS} days)..."
    CUTOFF_DATE=$(python3 -c "import datetime; print((datetime.datetime.now() - datetime.timedelta(days=${RETENTION_DAYS})).strftime('%Y%m%d'))")

    aws s3 ls "s3://${S3_BUCKET}/backups/postgresql/" | while read -r line; do
      FILE_NAME=$(echo $line | awk '{print $4}')
      FILE_DATE=$(echo "$FILE_NAME" | cut -d'_' -f3)

      if [ ! -z "$FILE_DATE" ] && [ "$FILE_DATE" -lt "$CUTOFF_DATE" ]; then
        echo "  Deleting old backup: ${FILE_NAME}"
        aws s3 rm "s3://${S3_BUCKET}/backups/postgresql/${FILE_NAME}"
      fi
    done

    # Limpar arquivo local
    rm -f "${BACKUP_FILE}"
    echo "âœ“ Local backup file removed"

    echo "=========================================="
    echo "Backup completed successfully!"
    echo "Finished at: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "=========================================="
